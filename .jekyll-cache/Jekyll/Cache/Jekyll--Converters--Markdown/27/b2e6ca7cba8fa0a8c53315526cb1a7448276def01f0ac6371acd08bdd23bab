I"<ul id="markdown-toc">
  <li><a href="#ssl" id="markdown-toc-ssl">SSL</a>    <ul>
      <li><a href="#共享密钥加密" id="markdown-toc-共享密钥加密">共享密钥加密</a></li>
      <li><a href="#公开密钥加密" id="markdown-toc-公开密钥加密">公开密钥加密</a></li>
      <li><a href="#https-采用混合加密方式" id="markdown-toc-https-采用混合加密方式">HTTPS 采用混合加密方式</a></li>
      <li><a href="#证明公开密钥正确性的证书" id="markdown-toc-证明公开密钥正确性的证书">证明公开密钥正确性的证书</a></li>
    </ul>
  </li>
  <li><a href="#https-的工作流程" id="markdown-toc-https-的工作流程">HTTPS 的工作流程</a></li>
</ul>

<p>在《图解 HTTP》书中，我们了解到为什么需要使用到安全的 HTTPS 通信。</p>

<ul>
  <li>通信使用明文会被窃听。所以进行加密处理防止被窃听，通过 SSL(Secure Socket Layer，安全套接层) 或 TLS(Transport Layer Security，安全层传输协议)组合使用，加密 HTTP 通信内容。</li>
  <li>通信方的身份可能遭遇伪装，HTTP 协议中的请求和响应不会对通信方进行确认。这个由 SSL 提供的数字证书来解决。</li>
  <li>无法确认报文的完整性。</li>
</ul>

<!-- more -->

<h2 id="ssl">SSL</h2>

<p>SSL 是独立于 HTTP 的协议，HTTPS 实际上就是在应用层(HTTP)和传输层(TCP)之间加了一层 SSL/TSL。</p>

<p>所以 HTTP 的做法就是，通过 SSL 建立安全的通信线路，然后在这条线路上进行 HTTP 通信。</p>

<p>SSL 采用一种叫做公开密钥加密的处理方式。</p>

<h3 id="共享密钥加密">共享密钥加密</h3>

<p>加密和解密使用同一个密钥的方式就叫做<strong>共享密钥加密</strong>，也叫对称密钥加密。使用这种方式加密必须将密钥也发送给对方。可是在互联网上进行转交，这是危险的。</p>

<h3 id="公开密钥加密">公开密钥加密</h3>

<p>公开密钥加密采用一对非对称的密钥。分别叫做 private key 和 public key。方式是，发送密文的一方使用<em>对方</em>的 public key 进行加密处理，对方收到加密的信息后，再使用自己的 private key 进行解密。</p>

<h3 id="https-采用混合加密方式">HTTPS 采用混合加密方式</h3>

<p>HTTPS 采用上述两种结合的加密方式。</p>

<ol>
  <li>使用 public key 加密方式安全地交换再稍后的共享密钥加密中要使用的密钥。</li>
  <li>确保交换的密钥是安全的前提下，使用共享密钥方式进行通信。</li>
</ol>

<blockquote>
  <p>public 密钥加密处理起来比共享密钥加密方式更复杂，所以在通信时使用公开密钥加密，效率就很低。</p>
</blockquote>

<h3 id="证明公开密钥正确性的证书">证明公开密钥正确性的证书</h3>

<p>公开你要加密的方式的问题是，无法证明公开密钥本身就是正确的公开密钥，所以使用由数字认证机构颁发的密钥证书。</p>

<hr />

<h2 id="https-的工作流程">HTTPS 的工作流程</h2>

<p>整个过程分为一下几个步骤:</p>

<ul>
  <li>验证证书的有效性</li>
  <li>握手生成会话密钥</li>
  <li>利用会话密钥及逆行内容传输</li>
</ul>

<ol>
  <li>客户端发出请求
客户端先向服务器发出加密通信的请求，被称作 <code class="highlighter-rouge">ClientHello</code> 请求。在这一步，客户端主要向服务器提供以下信息：
    <ul>
      <li>支持的协议版本，比如TLS 1.0版</li>
      <li>一个客户端生成的随机数，稍后用于生成“对话密钥”</li>
      <li>支持的加密方法，比如RSA公钥加密</li>
      <li>支持的压缩方法</li>
    </ul>
  </li>
  <li>服务器回应
服务器收到客户端请求后，向客户端发出回应，被称作 <code class="highlighter-rouge">ServerHello</code>。
    <ul>
      <li>确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版一致，服务器关闭加密通信</li>
      <li>一个服务器生成的随机数，稍后用于生成“对话密钥”</li>
      <li>确认使用的加密方法，比如RSA公钥加密</li>
      <li>服务器证书。</li>
    </ul>
  </li>
  <li>客户端验证证书
客户端收到服务器回应以后，首先验证服务器证书。</li>
  <li>客户端回应
如果证书没有问题，客户端就会从证书中取出服务器的 public key。然后，向服务器发送下面三项信息：
    <ul>
      <li>一个随机数</li>
      <li>编码改变通知</li>
      <li>客户端握手结束通知</li>
    </ul>
  </li>
  <li>生成会话密钥
步骤 4 生成的是整个握手阶段出现的第三个随机数，又称 <code class="highlighter-rouge">pre-master key</code>。客户端就同时拥有了三个随机数，接着就用事先商定的加密方法，生成本次会话所用的同一把“会话密钥”。
服务器收到客户端的第三个随机数之后，也生成本次会话所用的同一把“会话密钥”。</li>
  <li>服务器的最后回应
服务端生成“会话密钥”后，向客户端最后发送下面信息:
    <ul>
      <li>编码改变通知，表示随后的信息将用双方商定的加密方法和密钥发送。</li>
      <li>服务器握手结束通知，表示服务器的握手阶段已经结束。
至此，整个握手阶段全部结束。接下来，客户端和服务器进入加密通信，就完全是使用普通的 HTTP 协议，只不过“会话密钥”加密内容。</li>
    </ul>
  </li>
</ol>

<p>参考：</p>

<ul>
  <li><a href="http://www.jianshu.com/p/1429b12a5519">HTTPS运行原理</a></li>
  <li>《图解 HTTP》</li>
</ul>
:ET